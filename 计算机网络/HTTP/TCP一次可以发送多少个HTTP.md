> 众所周知，建立起一个TCP连接需要经过“三次握手”，而HTTP协议是建立在TCP协议之上的一种应用。

本文主要参考：[https://zhuanlan.zhihu.com/p/61423830](https://zhuanlan.zhihu.com/p/61423830)



本文围绕以下这些问题展开：

1. 现代浏览器在与服务器建立了一个 TCP 连接后是否会在一个 HTTP 请求完成后断开？什么情况下会断开？
2. 一个 TCP 连接可以对应几个 HTTP 请求？
3. 一个 TCP 连接中 HTTP 请求发送可以一起发送么（比如一起发三个请求，再三个响应一起接收）？
4. 为什么有的时候刷新页面不需要重新建立 SSL 连接？
5. 浏览器对同一 Host 建立 TCP 连接到数量有没有限制？
6. 浏览器需要加载有几十张图片的网页时，那么这些图片是以什么方式、什么顺序、建立了多少连接、使用什么协议被下载下来的呢？

## 1. 现代浏览器在与服务器建立了一个 TCP 连接后是否会在一个 HTTP 请求完成后断开？什么情况下会断开？

在 HTTP/1.0 中，一个服务器在发送完一个 HTTP 响应后，会断开 TCP 链接。但是这样每次请求都会重新建立和断开 TCP 连接，TCP建立连接时三次握手有1.5个RTT（round-trip time）的延迟，为了避免每次请求的都经历握手带来的延迟，应用层会选择不同策略的http长链接方案；TCP在建立连接的初期有慢启动（slow start）的特性，所以连接的重用总是比新建连接性能要好。

而HTTP1.1，HTTP 1.1支持持久连接（HTTP/1.1的默认模式使用带流水线的持久连接），在一个TCP连接上可以传送多个HTTP请求和响应。HTTP 1.1的 request和reponse头中都有可能出现一个connection的头，此header的含义是当client和server通信时对于长链接如何进行处理。

Connection请求头的值为Keep-Alive时，客户端通知服务器返回本次请求结果后保持连接；Connection请求头的值为close时，客户端通知服务器返回本次请求结果后关闭连接。HTTP 1.1还提供了与身份认证、状态管理和Cache缓存等机制相关的请求头和响应头。HTTP 1.1还支持文件断点续传，传送文件不用从头开始。



试了一下，访问[github.com](https://github.com/)

![第一次访问，有初始化连接和 SSL 开销](https://images-1253198264.cos.ap-guangzhou.myqcloud.com/image-20200601233238690.png)

![刷新，初始化连接和 SSL 开销消失了，说明使用的是同一个 TCP 连接](https://images-1253198264.cos.ap-guangzhou.myqcloud.com/image-20200601233316672.png)

所以答案是：**默认情况下建立 TCP 连接不会断开，只有在请求报头中声明 Connection: close 才会在请求完成后关闭连接**

## 2.一个 TCP 连接可以对应几个 HTTP 请求？

http1.1 的 tcp 连接复用，不能并行，第一个应答对应第一个请求，第二个应答对应第二个请求...依此类推。所以，理论上支持的请求数是没有限制的。所以，也没有数量限制，你可以在一个 tcp 连接上进行无数次 http 请求。

http2 的 tcp 多路复用，在一条连接里可以并发提供多条流。由于数据包是流的载体，所以不同的流互不相干，也就不存在 pipelining 里的响应顺序依赖的问题，后请求的可以先返回，并行多少个 http 请求是客户端决定的。基本上，不管多少个请求，都会只使用一个 tcp 连接，当然也不会有http请求数限制了。

## 3. 一个 TCP 连接中 HTTP 请求发送可以一起发送么（比如一起发三个请求，再三个响应一起接收）？

第二个答案说到，

HTTP/1.1 存在一个问题，单个 TCP 连接在同一时刻只能处理一个请求（串行），意思是说：两个请求的生命周期不能重叠，任意两个 HTTP 请求从开始到结束的时间在同一个 TCP 连接里不能重叠。

HTTP2.0 提供了 Multiplexing 多路传输特性，可以在一个 TCP 连接中同时完成多个 HTTP 请求。

![HTTP/1.1 串行与HTTP/2.0 并行](https://images-1253198264.cos.ap-guangzhou.myqcloud.com/image-20200601234240004.png)

## 4.为什么有的时候刷新页面不需要重新建立 SSL 连接？

HTTP1.0：规定客户端和服务器只能建立短暂连接，浏览器每次的请求都需要建立一个tcp连接，服务器完成请求后都会断开连接。

HTTP1.1：TCP 连接有的时候会被浏览器和服务端维持一段时间（Connection: keep-alive）。TCP 不需要重新建立，SSL 自然也会用之前的。

## 5.浏览器对同一 Host 建立 TCP 连接到数量有没有限制？

假设我们还处在 HTTP/1.1 时代，那个时候没有多路传输，当浏览器拿到一个有几十张图片的网页该怎么办呢？肯定不能只开一个 TCP 连接顺序下载，那样用户肯定等的很难受，但是如果每个图片都开一个 TCP 连接发 HTTP 请求，那电脑或者服务器都可能受不了，要是有 1000 张图片的话总不能开 1000 个TCP 连接吧，你的电脑同意 NAT 也不一定会同意。

引入了持久连接，即TCP连接默认不关闭，可以被多个请求复用，不用声明Connection: keep-alive(对于同一个域名，大多数浏览器允许同时建立6个持久连接。

## 6.收到的 HTML 如果包含几十个图片标签，这些图片是以什么方式、什么顺序、建立了多少连接、使用什么协议被下载下来的呢？

如果图片都是 HTTPS 连接并且在同一个域名下，那么浏览器在 SSL 握手之后会和服务器商量能不能用 HTTP2，如果能的话就使用 Multiplexing 功能在这个连接上进行多路传输。不过也未必会所有挂在这个域名的资源都会使用一个 TCP 连接去获取，但是可以确定的是 Multiplexing 很可能会被用到。

如果发现用不了 HTTP2 呢？或者用不了 HTTPS（现实中的 HTTP2 都是在 HTTPS 上实现的，所以也就是只能使用 HTTP/1.1）。那浏览器就会在一个 HOST 上建立多个 TCP 连接，连接数量的最大限制取决于浏览器设置，这些连接会在空闲的时候被浏览器用来发送新的请求，如果所有的连接都正在发送请求呢？那其他的请求就只能等等了。



参考：

[https://zhuanlan.zhihu.com/p/61423830](https://zhuanlan.zhihu.com/p/61423830)

[https://www.v2ex.com/t/397627](https://www.v2ex.com/t/397627)